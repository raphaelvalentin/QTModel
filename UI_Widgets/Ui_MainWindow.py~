# -*- coding: utf-8 -*-

"""
Author: Raphael.
"""



from PyQt4 import QtCore, QtGui
from QTextEdit import Ui_QTextEditWindow
from QTParamBox import Ui_QTParamBox
from Ui_SubWindow import *
import sys, os


from syntax import Bench
def isclass(obj):
    return hasattr(obj, '__dict__')

from UI_Widgets.QInterPy import *
#from Queue import Queue



class GenericThread(QtCore.QThread):
    def __init__(self, function, *args, **kwargs):
        QtCore.QThread.__init__(self)
        self.function = function
        self.args = args
        self.kwargs = kwargs

    def __del__(self):
        self.wait()

    def run(self):
        self.function(*self.args,**self.kwargs)
        return



try:
    _fromUtf8 = QtCore.QString.fromUtf8
except AttributeError:
    def _fromUtf8(s):
        return s

try:
    _encoding = QtGui.QApplication.UnicodeUTF8
    def _translate(context, text, disambig):
        return QtGui.QApplication.translate(context, text, disambig, _encoding)
except AttributeError:
    def _translate(context, text, disambig):
        return QtGui.QApplication.translate(context, text, disambig)

from exec_script import *
__data__ = { 'model' : {},
             'bench' : {},
             'plot'  : {},
             'parameter' : [],
            }

class Ui_MainWindow(object):
    def setupUi(self, MainWindow):
        MainWindow.setObjectName(_fromUtf8("MainWindow"))
        MainWindow.resize(800, 600)
        MainWindow.setSizeIncrement(QtCore.QSize(10, 10))
        self.centralwidget = QtGui.QWidget(MainWindow)
        self.centralwidget.setObjectName(_fromUtf8("centralwidget"))
        self.verticalLayout = QtGui.QVBoxLayout(self.centralwidget)
        self.verticalLayout.setSpacing(0)
        self.verticalLayout.setMargin(0)
        self.verticalLayout.setObjectName(_fromUtf8("verticalLayout"))
        self.mdiArea = QtGui.QMdiArea(self.centralwidget)
        self.mdiArea.setSizeIncrement(QtCore.QSize(0, 0))
        self.mdiArea.setObjectName(_fromUtf8("mdiArea"))
        self.verticalLayout.addWidget(self.mdiArea)
        MainWindow.setCentralWidget(self.centralwidget)
        # status bar
        self.statusbar = QtGui.QStatusBar(MainWindow)
        self.statusbar.setObjectName(_fromUtf8("statusbar"))
        MainWindow.setStatusBar(self.statusbar)
        
        # create actions
        self.createActions(MainWindow)
        
        # create menu
        self.menubar = QtGui.QMenuBar(MainWindow)
        self.menubar.setGeometry(QtCore.QRect(0, 0, 800, 25))
        self.menubar.setObjectName(_fromUtf8("menubar"))
        MainWindow.setMenuBar(self.menubar)
        self.menubarUi(MainWindow)
        
        
        self.createDockWindows(MainWindow)

        MainWindow.setWindowTitle("QTModel")


        self.retranslateUi(MainWindow)

        self.current_path = './Projects'        


        QtCore.QObject.connect(self.mdiArea, QtCore.SIGNAL('subWindowActivated(QMdiSubWindow*)'), lambda subwindow: self.changedFocusSlot(MainWindow, subwindow))


        QtCore.QMetaObject.connectSlotsByName(MainWindow)
        

        
    def retranslateUi(self, MainWindow):
        MainWindow.setWindowTitle(_translate("MainWindow", "MainWindow", None))

    # create actions
    def createActions(self, MainWindow):
        self.newModelScriptAct = QtGui.QAction("&Model Script", MainWindow,
                statusTip="Create a new model file", 
                triggered=lambda: self.newModelScript(MainWindow))
                
        self.newParameterBoxAct = QtGui.QAction("&Parameter Box", MainWindow,
                statusTip="Create a new parameter box", 
                triggered=lambda: self.newParameterBox(MainWindow))
                
        self.newBenchScriptAct = QtGui.QAction("&Bench Script", MainWindow,
                statusTip="Create a new bench file", 
                triggered=lambda: self.newBenchScript(MainWindow))
                
        self.newPlotScriptAct = QtGui.QAction("&Plot Script", MainWindow,
                statusTip="Create a new plot file", 
                triggered=lambda: self.newPlotScript(MainWindow))
                
        self.newOptimScriptAct = QtGui.QAction("&Optim Script", MainWindow,
                statusTip="Create a new optim file", 
                triggered=lambda: self.newOptimScript(MainWindow))
        
        self.openAct = QtGui.QAction("&Open...", MainWindow,
                shortcut=QtGui.QKeySequence.Open,
                statusTip="Open an existing file", 
                triggered=lambda: self.loadFile(MainWindow))

        self.saveAct = QtGui.QAction("&Save", MainWindow,
                shortcut=QtGui.QKeySequence.Save,
                statusTip="Save the document to disk", 
                triggered=lambda: self.saveFile(MainWindow))

        self.saveAsAct = QtGui.QAction("Save &As...", MainWindow,
                shortcut=QtGui.QKeySequence.SaveAs,
                statusTip="Save the document under a new name",
                triggered=lambda: None)

        self.exitAct = QtGui.QAction("E&xit", MainWindow, 
                shortcut="Ctrl+Q",
                statusTip="Exit the application",
                triggered=lambda: self.exitApp(MainWindow))

        self.tileAct = QtGui.QAction("&Tile", MainWindow, 
                shortcut="Ctrl+T",
                statusTip="Tile the windows",
                triggered=self.mdiArea.tileSubWindows)

        self.cascadeAct = QtGui.QAction("&Cascade", MainWindow, 
                 shortcut="Ctrl+C",
                statusTip="Cascade the windows",
                triggered=self.mdiArea.cascadeSubWindows)

        self.aboutQtAct = QtGui.QAction("About &Qt", MainWindow,
                statusTip="Show the Qt library's About box",
                triggered=QtGui.qApp.aboutQt)

        self.aboutAct = QtGui.QAction("&About", MainWindow,
                statusTip="Show the About box",
                triggered=lambda: self.aboutMessageBox(MainWindow))

        self.AttachToProjectAct = QtGui.QAction("Attach to Project", MainWindow,
                statusTip="Attach the file to the project",
                triggered=lambda: self.attachToProject())

        self.AddRowAct = QtGui.QAction("Add Row", MainWindow,
                statusTip="Add a row of the table",
                triggered=lambda: self.mdiArea.activeSubWindow().addEmptyRow())

        self.DelRowAct = QtGui.QAction("Delete Row", MainWindow,
                statusTip="Delete rows of the table",
                triggered=lambda: self.mdiArea.activeSubWindow().delRow())

        self.ExecuteBenchAct = QtGui.QAction("Execute", MainWindow,
                statusTip="Execute the bench",
                triggered=lambda: self.executeBench(self.DockDataTreeSubWindow.getSelectedRow()))

        self.TracePlotAct = QtGui.QAction("Trace Plot", MainWindow,
                statusTip="Trace the plot",
                triggered=lambda: self.tracePlot(self.DockDataTreeSubWindow.getSelectedRow()))

        self.OpenCursorBoxAct = QtGui.QAction("Cursor Box", MainWindow,
                statusTip="Open the cursor box window",
                triggered=lambda: self.newCursorBoxWindow(MainWindow))

        self.AutoExecuteAct = QtGui.QAction("Auto Execute", MainWindow,
                statusTip="Auto Execute the benches", checkable=True
                )




    # define the initial menubar
    def menubarUi(self, MainWindow):
        self.menubar.clear()
        
        # set top-level menu bar 
        self.menuFile = QtGui.QMenu(self.menubar)
        self.menuFile.setObjectName(_fromUtf8("menuFile"))
        self.menuFile.setTitle(_translate("MainWindow", "File", None)) 
        self.menubar.addAction(self.menuFile.menuAction())

        self.menuEdit = QtGui.QMenu(self.menubar)
        self.menuEdit.setObjectName(_fromUtf8("menuEdit"))
        self.menuEdit.setTitle(_translate("MainWindow", "Edit", None))
        self.menubar.addAction(self.menuEdit.menuAction())

        self.menuView = QtGui.QMenu(self.menubar)
        self.menuView.setObjectName(_fromUtf8("menuWindow"))
        self.menuView.setTitle(_translate("MainWindow", "View", None))
        self.menubar.addAction(self.menuView.menuAction())

        self.menuWindow = QtGui.QMenu(self.menubar)
        self.menuWindow.setObjectName(_fromUtf8("menuWindow"))
        self.menuWindow.setTitle(_translate("MainWindow", "Window", None))
        self.menubar.addAction(self.menuWindow.menuAction())

        self.menuAction = QtGui.QMenu(self.menubar)
        self.menuAction.setObjectName(_fromUtf8("menuAction"))
        self.menuAction.setTitle(_translate("MainWindow", "Actions", None))
        self.menubar.addAction(self.menuAction.menuAction())
        
        self.menuHelp = QtGui.QMenu(self.menubar)
        self.menuHelp.setObjectName(_fromUtf8("menuHelp"))
        self.menuHelp.setTitle(_translate("MainWindow", "&Help", None))
        self.menubar.addAction(self.menuHelp.menuAction())
        
        # set second-level menu bar
        self.menuFileNew = QtGui.QMenu(self.menubar)
        self.menuFileNew.setObjectName(_fromUtf8("menuFile"))
        self.menuFileNew.setTitle(_translate("MainWindow", "New", None)) 
        self.menuFile.addAction(self.menuFileNew.menuAction())
        
        self.menuFileNew.addAction( self.newModelScriptAct )
        self.menuFileNew.addAction( self.newParameterBoxAct )
        self.menuFileNew.addAction( self.newBenchScriptAct )
        self.menuFileNew.addAction( self.newPlotScriptAct )
        self.menuFileNew.addAction( self.newOptimScriptAct )
                
        self.menuFile.addAction( self.openAct )
        self.menuFile.addAction( self.saveAct )
        self.menuFile.addAction( self.saveAsAct )
        self.menuFile.addAction( self.exitAct )
        
        #self.menuEdit.addAction( self.AutoExpandTreeAct )

        self.menuWindow.addAction( self.tileAct )
        self.menuWindow.addAction( self.cascadeAct )

        self.menuAction.addAction( self.AttachToProjectAct )
        self.menuAction.addAction( self.ExecuteBenchAct )
        self.menuAction.addAction( self.AutoExecuteAct )
        
        self.menuHelp.addAction( self.aboutAct )
        self.menuHelp.addAction( self.aboutQtAct )


    def exitApp(self, MainWindow):
        QtGui.qApp.closeAllWindows()
        QtGui.QApplication.quit()
        raise SystemExit()

    #---------------------------------------------------------------------------
    def createDockWindows(self, MainWindow):
    
        self.DockLogSubWindow = DockLogSubWindow(MainWindow)
        self.menuView.addAction(self.DockLogSubWindow.toggleViewAction())

        # log listener
        self.thread1 = QtCore.QThread()
        self.my_receiver = MyReceiver(queue)
        self.my_receiver.mysignal.connect(self.DockLogSubWindow.append)
        self.my_receiver.moveToThread(self.thread1)
        self.thread1.started.connect(self.my_receiver.run)
        self.thread1.start()

        self.DockDataTreeSubWindow = DockDataTreeSubWindow(MainWindow)
        self.DockDataTreeSubWindow.setData(__data__)
        self.menuView.addAction(self.DockDataTreeSubWindow.toggleViewAction())
        
        self.DockDataTreeSubWindow.currentValueChanged.connect( self.changedCurrentTreeItem )


        #self.customerList.currentTextChanged.connect(self.insertCustomer)
        #self.paragraphsList.currentTextChanged.connect(self.addParagraph)

    def executeBench(self, index):

        def pseudofunction(self, index):
            key = index.text()
            value = __data__['bench'][key]['__obj__']
            environ = dict(__data__['model'])
            environ[key] = value
            interpy = QInterpy(locals=environ)
            instances = {}
            for subwindow in __data__['parameter']:
                print dict(subwindow.iteritems())
                instances.update( dict(subwindow.iteritems()) )
            cmd = ";".join([ 'kwargs=%s'        % str(instances), 
                             'obj=%s'           % key,
                             '_=%s(**kwargs)'   % key ])    
            interpy.runsource(cmd, filename=key)

            def finished(self, interpy, index):
                key = index.text()
                obj = interpy.locals['obj']
                __data__['bench'][key] = {'__obj__':obj}
                self.DockDataTreeSubWindow.setData(__data__)
                    
            interpy.finished.connect(lambda:finished(self, interpy, index))
            interpy.start()

        if index.parent().text() == "bench":
            pseudofunction(self, index)

        elif index.text() == "bench":
            for child in index.childs():
                if child.ischeck():
                    pseudofunction(self, child)


        # update plots
        opened = []
        for subwindow in self.mdiArea.subWindowList():
            if isinstance(subwindow, QMdiPlotSubWindow) and subwindow.isClosed() == False:
                opened.append(subwindow.name())
                

        for indx in self.DockDataTreeSubWindow.getPlotIndexes():
            if indx.text() in opened:
                self.tracePlot(indx)



    def tracePlot(self, index):

        def pseudofunction(self, index):
            key = index.text()
            value = __data__['plot'][key]
            environ = dict({name:bench['__obj__'] for name, bench in __data__['bench'].iteritems()})
            environ[key] = value
            interpy = QInterpy(locals=environ)
            interpy.runsource( "obj = %s()" % (key), filename=key )

            def finished(self, interpy, index):
                key = index.text()
                plt = interpy.locals['obj']
                find = False
                for subwindow in self.mdiArea.subWindowList():
                    if isinstance(subwindow, QMdiPlotSubWindow) and subwindow.name() == key:
                        subwindow.update( plt )
                        find = True
                        break
                if find == False:
                    plotWindow = QMdiPlotSubWindow(self.mdiArea, plt)
                    plotWindow.setName( key )

            interpy.finished.connect(lambda:finished(self, interpy, index))
            interpy.start()

        
        if index.parent().text()  == "plot":
            pseudofunction(self, index)
            
    def autoexecute(self):
        autoexecute = self.AutoExecuteAct.isChecked()
        if autoexecute:
            index = self.DockDataTreeSubWindow.getBenchIndex()
            self.executeBench(index)
    
    #---------------------------------------------------------------------------
    def setExistingDirectory(self, MainWindow):    
        options = QtGui.QFileDialog.DontResolveSymlinks | QtGui.QFileDialog.ShowDirsOnly
        directory = QtGui.QFileDialog.getExistingDirectory(MainWindow,
                "Select A Root Folder For The Project",
                '', options)
        return directory

    def newModelScript(self, MainWindow):
        QMdiModelScriptSubWindow(self.mdiArea)
        
    def newBenchScript(self, MainWindow):
        QMdiBenchScriptSubWindow(self.mdiArea)

    def newParameterBox(self, MainWindow):
        QMdiParameterBoxSubWindow(self.mdiArea)
        
    def newPlotScript(self, MainWindow):
        QMdiPlotScriptSubWindow(self.mdiArea)
        
    def newCursorBoxWindow(self, MainWindow):
        index = self.DockDataTreeSubWindow.getSelectedRow()
        if index.parent().text() == 'param':
            for subwindow in __data__['parameter']:
                if os.path.split(subwindow.filename())[-1] == index.text():
                    data = subwindow.data()
                    cursorBox = QMdiCursorSubWindow(self.mdiArea, data)
                    cursorBox.valueChanged.connect( subwindow.setValue )
                    

    def loadFile(self, MainWindow):

        self.filename = QtGui.QFileDialog.getOpenFileName(None,
            'Open a Parameter Data File', self.current_path, 'All Files (*.*)')
        if self.filename is None: 
            self.statusbar.showMessage( 'No file has been selected...')
            return False
        self.filename = str(self.filename)
        
        try:
            f = open(self.filename)
            string = f.read()
            f.close()
        except:
            self.statusbar.showMessage( 'Failed to load the file. The file cannot be read...')
            return False
            
        lines =   string.splitlines()


        if len(lines) and lines[0].strip()=="# -*- type: parameters -*-":
            lines.pop(0)
            try:
                table = []
                for line in lines:
                    line = line.strip()
                    if line=='': 
                        continue
                    data = line.split()
                    table.append([data[0], data[1], data[2], data[3]])
                subwindow = QMdiParameterBoxSubWindow(self.mdiArea)
                subwindow.setWindowTitle( self.filename.split('/')[-1].split('\\')[-1] + ' - ' + self.filename )
                subwindow.setData(table)
                subwindow.setFilename(self.filename)
            except:
                self.statusbar.showMessage( 'Failed to load the file. The file has a wrong format...')
                return False
            # add path for import module
            sys.path.append(os.path.dirname(self.filename))
            self.statusbar.showMessage( "Successfully Loaded " + self.filename ) 
            return True

        if len(lines) and lines[0].strip()=="# -*- type: model -*-":
            lines.pop(0); lines.pop(0); 
            subwindow = QMdiModelScriptSubWindow(self.mdiArea)
            subwindow.setWindowTitle( self.filename.split('/')[-1].split('\\')[-1] + ' - ' + self.filename )
            subwindow.setText('\n'.join(lines))
            subwindow.setFilename(self.filename)
            self.statusbar.showMessage( "Successfully Loaded " + self.filename ) 
            return True            

        if len(lines) and lines[0].strip()=="# -*- type: bench -*-":
            lines.pop(0); lines.pop(0); 
            subwindow = QMdiBenchScriptSubWindow(self.mdiArea)
            subwindow.setWindowTitle( self.filename.split('/')[-1].split('\\')[-1] + ' - ' + self.filename )
            subwindow.setText('\n'.join(lines))
            subwindow.setFilename(self.filename)
            self.statusbar.showMessage( "Successfully Loaded " + self.filename ) 
            return True            

        if len(lines) and lines[0].strip()=="# -*- type: plot -*-":
            lines.pop(0); lines.pop(0); 
            subwindow = QMdiPlotScriptSubWindow(self.mdiArea)
            subwindow.setWindowTitle( self.filename.split('/')[-1].split('\\')[-1] + ' - ' + self.filename )
            subwindow.setText('\n'.join(lines))
            subwindow.setFilename(self.filename)
            self.statusbar.showMessage( "Successfully Loaded " + self.filename ) 
            return True            





        self.statusbar.showMessage( 'Failed to load the file. The file has a wrong format...')   
        return False     

    def saveFile(self, MainWindow):
        subwindow = self.mdiArea.activeSubWindow()
        filename = subwindow.filename()
        
        if isinstance(subwindow, QMdiParameterBoxSubWindow):
            data = subwindow.data()
            g = open(filename, 'w')
            g.write("# -*- type: parameters -*-\n")
            for row in data:
                g.write("\t".join([str(e) for e in row]) + "\n")
            g.close()
            self.statusbar.showMessage( "Successfully Saved " + self.filename ) 
        elif isinstance(subwindow, QMdiBenchScriptSubWindow):
            string = subwindow.text()
            if string.splitlines()[0].strip() <> "# -*- type: bench -*-":
                self.statusbar.showMessage( 'Failed to save the file. The file does not have a compliant title...')                   
            g = open(filename, 'w')
            g.write(string)
            g.close()
            self.statusbar.showMessage( "Successfully Saved " + self.filename ) 
        elif isinstance(subwindow, QMdiModelScriptSubWindow):
            string = subwindow.text()
            if string.splitlines()[0].strip() <> "# -*- type: model -*-":
                self.statusbar.showMessage( 'Failed to save the file. The file does not have a compliant title...')                   
            g = open(filename, 'w')
            g.write(string)
            g.close()
            self.statusbar.showMessage( "Successfully Saved " + self.filename )         
        elif isinstance(subwindow, QMdiPlotScriptSubWindow):
            string = subwindow.text()
            if string.splitlines()[0].strip() <> "# -*- type: plot -*-":
                self.statusbar.showMessage( 'Failed to save the file. The file does not have a compliant title...')                   
            g = open(filename, 'w')
            g.write(string)
            g.close()
            self.statusbar.showMessage( "Successfully Saved " + self.filename )         


    def changedFocusSlot(self, MainWindow, subwindow):
        if isinstance(subwindow, QMdiParameterBoxSubWindow):
            self.menuAction.clear()
            self.menuAction.addAction( self.AttachToProjectAct )
            self.menuAction.addAction( self.AddRowAct )
            self.menuAction.addAction( self.DelRowAct )
            self.menuAction.addAction( self.OpenCursorBoxAct )            
        elif isinstance(subwindow, QMdiBenchScriptSubWindow):
            self.menuAction.clear()
            self.menuAction.addAction( self.AttachToProjectAct )
            #self.menuAction.addAction( self.ExecuteBenchAct )
        elif isinstance(subwindow, QMdiModelScriptSubWindow):
            self.menuAction.clear()
            self.menuAction.addAction( self.AttachToProjectAct )
        elif isinstance(subwindow, QMdiPlotScriptSubWindow):
            self.menuAction.clear()
            self.menuAction.addAction( self.AttachToProjectAct )
            #self.menuAction.addAction( self.TracePlotAct )
       
    #def changedCurrentTreeItem(self, item):
    #    if len(item)==1:
    #        root,  = item
    #    if len(item)==2:
    #        root, child = item
    #    if root in ('bench', 'plot'):
    #        if not self.ExecuteAct in self.menuAction.actions():
    #            self.menuAction.addAction( self.ExecuteAct )                
    #    if root in ('model',):
    #        if self.ExecuteAct in self.menuAction.actions():
    #            actions = list(self.menuAction.actions())
    #            self.menuAction.clear()
    #            for action in actions:
    #                if not action is self.ExecuteAct:
    #                    self.menuAction.addAction( action )
       
    def changedCurrentTreeItem(self, index):
        #print index.text(), index.ischeck()
        #for child in index.childs():
        #    print child.text(), child.ischeck()
    
        if index.text() in ('bench',) or index.parent().text() in ('bench',):
            if not self.ExecuteBenchAct in self.menuAction.actions():
                self.menuAction.addAction( self.ExecuteBenchAct )
                self.menuAction.addAction( self.AutoExecuteAct )
        if index.text() in ('plot',) or index.parent().text() in ('plot',):
            if not self.TracePlotAct in self.menuAction.actions():
                self.menuAction.addAction( self.TracePlotAct )
        if index.text() in ('model',) or index.parent().text() in ('model',):
            if self.ExecuteBenchAct in self.menuAction.actions():
                actions = list(self.menuAction.actions())
                self.menuAction.clear()
                for action in actions:
                    if not action is self.ExecuteBenchAct:
                        self.menuAction.addAction( action )




    def attachToProject(self):

        subwindow = self.mdiArea.activeSubWindow()
        if isinstance(subwindow, QMdiModelScriptSubWindow):
            script = str(subwindow.text())
            # run the script and extract the add-on data
            obj1 = Interpy()
            glob1 = dict(obj1.context()).keys()
            obj1.runsource(script, filename='<script>', symbol="exec")
            if obj1.stderr.strip()<>"":
                print obj1.stderr.strip()
            if obj1.stdout.strip()<>"":
                print obj1.stdout.strip()
            
            glob2 = dict(obj1.context())
            for key, item in glob2.iteritems():
                if key in glob1: continue
                if isclass(item):
                    __data__['model'][key] = item
            # fix to solve that context is updated
            for key, item in __data__['model'].iteritems():
                if key in glob2.keys():
                    __data__['model'][key] = glob2[key]

            self.DockDataTreeSubWindow.setData(__data__)     
            self.statusbar.showMessage( 'Model attached successfully.') 

                    
        elif isinstance(subwindow, QMdiBenchScriptSubWindow):
            script = str(subwindow.text())
            # run the script and extract the add-on data
            obj1 = Interpy()
            glob1 = dict(obj1.context()).keys()
            obj1.runsource(script, filename='<script>', symbol="exec")
            if obj1.stderr.strip()<>"":
                print obj1.stderr.strip()
            if obj1.stdout.strip()<>"":
                print obj1.stdout.strip()

            glob2 = dict(obj1.context())
            for key, item in glob2.iteritems():
                if key in glob1: continue
                if getattr(item, '__type__', False) and item.__type__ == 'Bench':
                    __data__['bench'][key] = {'__obj__':item}
                    #for key2, value2 in  item.__dict__.iteritems():
                    #    if isintance(value2, list):
                    #        __data__['bench'][key][key2] = value2
            # fix to solve that context is updated
            for key, item in __data__['bench'].iteritems():
                if key in glob2.keys():
                    __data__['bench'][key] = {'__obj__':glob2[key]}

            self.DockDataTreeSubWindow.setData(__data__)     
            self.statusbar.showMessage( 'Bench attached successfully.')                   

                    
        elif isinstance(subwindow, QMdiPlotScriptSubWindow):
            script = str(subwindow.text())
            filename = subwindow.filename()
            # run the script and extract the add-on data
            self.thread = QtCore.QThread()
            self.obj1 = QInterpy()
            initenv = dict(self.obj1.locals)
            self.obj1.runsource( script, filename=filename)
            self.obj1.moveToThread(self.thread)
            self.obj1.finished.connect(self.thread.quit)
            self.thread.started.connect(self.obj1.run)
            self.thread.start()
            self.thread.finished.connect(lambda:self.attach_finished(subwindow, initenv, self.obj1))
            
        elif isinstance(subwindow, QMdiParameterBoxSubWindow):
            __data__['parameter'].append( subwindow )
            self.DockDataTreeSubWindow.setData(__data__)
            subwindow.itemChanged.connect( self.autoexecute  )     
            self.statusbar.showMessage( 'Parameter File attached successfully.')


    def attach_finished(self, subwindow, initenv, exe):
        if isinstance(subwindow, QMdiPlotScriptSubWindow):
            plots = dict()
            for key, item in exe.locals.iteritems():
                if initenv.has_key(key): continue
                if isclass(item):
                    plots[key] = item
            # fix to solve that context is updated
            for key, item in __data__['plot'].iteritems():
                if exe.locals.has_key(key):
                    plots[key] = exe.locals[key]
            for key, item in plots.iteritems():
                __data__['plot'][key] = item
            self.DockDataTreeSubWindow.setData(__data__)     
            self.statusbar.showMessage( 'Plot attached successfully.')


    def aboutMessageBox(self, MainWindow):
        msg = __doc__
        QtGui.QMessageBox.about(MainWindow, "About the QTModel", msg.strip())
        




